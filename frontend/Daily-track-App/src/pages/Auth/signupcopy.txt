
import React, { useState, useContext } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import AuthLayout from '../../components/layouts/AuthLayout';
import ProfilePhotoSelector from '../../components/inputs/ProfilePhotoSelector';
import Input from '../../components/inputs/input';
import { FaUser, FaEnvelope, FaLock, FaKey, FaCheckCircle, FaRocket } from 'react-icons/fa';
import { validateEmail } from '../../utils/helper';
import axiosInstance from '../../utils/axiosInstance';
import { API_PATHS } from '../../utils/apiPaths';
import { UserContext } from '../../context/UserContext';
import uploadImage from '../../utils/uploadimage';

const SignUp = () => {
  const [profilePic, setProfilePic] = useState(null);
  const [fullName, setFullName] = useState("");
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [adminInviteToken, setAdminInviteToken] = useState('');
  const [error, setError] = useState(null);

  const { updateUser } = useContext(UserContext);
  const navigate = useNavigate();

  const handleSignUp = async (e) => {
    e.preventDefault();

    // --- Input Validation ---
    if (!fullName) {
      setError("Please enter your full name.");
      return;
    }
    if (!validateEmail(email)) {
      setError("Please enter a valid email address.");
      return;
    }
    if (!profilePic) {
      setError("Please upload a profile picture.");
      return;
    }
    if (!password || password.length < 8) {
      setError("Password must be at least 8 characters long.");
      return;
    }
    setError(null);

    // --- API Call Logic ---
    try {
      let profileImageUrl = "";
      // Step 1: Upload image if one is selected
      if (profilePic) {
        const imgUploadRes = await uploadImage(profilePic);
        profileImageUrl = imgUploadRes.url || "";
      }

      // Step 2: Call the signup API
      const response = await axiosInstance.post(API_PATHS.AUTH.SIGNUP, {
        name: fullName,
        email,
        password,
        profileImageUrl,
        adminInviteToken
      });

      // Step 3: Let the context handle state and localStorage
      updateUser(response.data);

      // Step 4: Redirect based on role
      const { role } = response.data;
      if (role === 'admin') {
        navigate('/admin/dashboard');
      } else {
        navigate('/user/dashboard');
      }

    } catch (err) {
      // Handle any error from image upload or signup API
      if (err.response && err.response.data.message) {
        setError(err.response.data.message);
      } else {
        setError("Something went wrong. Please try again.");
      }
    }
  };

  return (
    <AuthLayout variant="signup">
      <div className="w-full h-auto md:h-full mt-0 md:mt-0 flex flex-col justify-center">
        {/* Header Section */}
        <div className="text-center mb-5">
          <div className="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 rounded-full mb-3 shadow-xl">
            <FaRocket className="text-white text-5xl" />
          </div>
          <h3 className="text-2xl font-bold mb-3 bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent drop-shadow-lg">
            Join Our Community
          </h3>
          <p className="text-base text-white/80 max-w-lg mx-auto leading-relaxed drop-shadow-md">
            Start your journey with our powerful task management platform.
          </p>
        </div>

        <form onSubmit={handleSignUp} className="space-y-8">
          {/* Profile Photo Section */}
          <div className="text-center">
            <ProfilePhotoSelector image={profilePic} setImage={setProfilePic} />
            <p className="text-sm text-white/70 mt-3 font-medium">Upload your profile picture</p>
          </div>

          {/* Input Grid */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
            <div className="space-y-3">
              <div className="flex items-center gap-3 mb-3">
                <div className="w-8 h-8 bg-gradient-to-r from-blue-500 to-blue-500 rounded-full flex items-center justify-center">
                  <FaUser className="text-white text-sm" />
                </div>
                <label className="font-semibold text-white/90">Full Name</label>
              </div>
              <Input
                value={fullName}
                onChange={(e) => setFullName(e.target.value)}
                placeholder="Enter your full name"
                type="text"
              />
            </div>

            <div className="space-y-3">
              <div className="flex items-center gap-3 mb-3">
                <div className="w-8 h-8 bg-gradient-to-r from-purple-500 to-violet-500 rounded-full flex items-center justify-center">
                  <FaEnvelope className="text-white text-sm" />
                </div>
                <label className="font-semibold text-white/90">Email Address</label>
              </div>
              <Input
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="john234@example.com"
                type="email"
              />
            </div>

            <div className="space-y-3">
              <div className="flex items-center gap-3 mb-3">
                <div className="w-8 h-8 bg-gradient-to-r from-pink-500 to-red-500 rounded-full flex items-center justify-center">
                  <FaLock className="text-white text-sm" />
                </div>
                <label className="font-semibold text-white/90">Create Password</label>
              </div>
              <Input
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="Enter Password"
                type="password"
              />
            </div>

            <div className="space-y-3">
              <div className="flex items-center gap-3 mb-3">
                <div className="w-8 h-8 bg-gradient-to-r from-indigo-500 to-blue-500 rounded-full flex items-center justify-center">
                  <FaKey className="text-white text-sm" />
                </div>
                <label className="font-semibold text-white/90">Admin Invite Token</label>
              </div>
              <Input
                value={adminInviteToken}
                onChange={(e) => setAdminInviteToken(e.target.value)}
                placeholder="6 Digit Code"
                type="text"
              />
            </div>
          </div>

          {/* Error Display */}
          {error && (
            <div className="bg-red-500/20 backdrop-blur-sm border border-red-300/30 rounded-xl p-4 shadow-sm">
              <p className="text-red-200 text-sm flex items-center gap-3">
                <span className="w-3 h-3 bg-red-400 rounded-full animate-pulse"></span>
                {error}
              </p>
            </div>
          )}

          {/* Submit Button */}
          <button
            type="submit"
            className="w-full bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 text-white py-4 px-8 rounded-xl font-bold shadow-xl hover:from-blue-600 hover:via-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-purple-300 focus:ring-offset-2"
          >
            <span className="flex items-center justify-center gap-3 text-lg">
              <FaCheckCircle className="text-xl" />
              CREATE ACCOUNT
            </span>
          </button>

          {/* Login Link */}
          <div className="text-center pt-4">
            <p className="text-base text-white/80">
              Already have an account?{" "}
              <Link
                to="/login"
                className="font-bold text-purple-300 hover:text-blue-200 underline decoration-2 underline-offset-4 transition-colors hover:decoration-purple-400"
              >
                Login here
              </Link>
            </p>
          </div>
        </form>
      </div>
    </AuthLayout>
  );
};

export default SignUp;
